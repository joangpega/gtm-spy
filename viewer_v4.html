<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Tag Manager Spy üíõ by Jose Angel Perez</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;line-height:1.6;color:#e2e8f0;background-color:#121212;min-height:100vh;padding:20px}.container{max-width:1200px;margin:0 auto;background:#1e1e1e;border-radius:15px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,0.3);border:1px solid #2d3748}h1{text-align:center;color:#fff;margin-bottom:30px;font-size:2.5em;font-weight:700}h2,h6{text-align:center;color:#fff;margin-bottom:20px;font-size:1em;font-weight:400}.custom-link{color:#FFD700;text-decoration:none}.input-section{margin-bottom:30px;padding:20px;background:#2d3748;border-radius:10px;border:2px dashed #4a5568}textarea{width:100%;height:150px;padding:15px;border:2px solid #4a5568;border-radius:8px;font-family:'Courier New',monospace;font-size:14px;resize:vertical;transition:border-color 0.3s ease;background-color:#2d3748;color:#e2e8f0}textarea:focus{outline:none;border-color:#63b3ed;box-shadow:0 0 0 3px rgba(99,179,237,0.2)}.buttons{margin-top:15px;display:flex;gap:15px;flex-wrap:wrap}button{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s ease;font-size:14px}.btn-primary{background:linear-gradient(45deg,#4299e1,#3182ce);color:white}.btn-secondary{background:#4a5568;color:#e2e8f0}.btn-tertiary{background:#38a169;color:white}button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.4);opacity:0.9}.file-input{display:none}.file-input-label{display:inline-block;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s ease;font-size:14px;background:#38a169;color:white}.file-input-label:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.4);opacity:0.9}.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}.stat-card{background:linear-gradient(45deg,#2b6cb0,#2c5282);color:white;padding:20px;border-radius:10px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.2)}.stat-number{font-size:2em;font-weight:bold;display:block}.stat-label{font-size:0.9em;opacity:0.9}.categories{display:grid;gap:20px}.category{background:#2d3748;border-radius:10px;overflow:hidden;border:1px solid #4a5568}.category-header{background:linear-gradient(45deg,#2b6cb0,#3182ce);color:white;padding:15px 20px;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:background 0.3s ease}.category-header:hover{background:linear-gradient(45deg,#2c5282,#2b6cb0)}.category-content{padding:20px;display:none}.category.expanded .category-content{display:block}.toggle-icon{transition:transform 0.3s ease}.category.expanded .toggle-icon{transform:rotate(180deg)}.item{background:#2d3748;margin-bottom:15px;padding:15px;border-radius:8px;border-left:4px solid #4299e1;box-shadow:0 2px 5px rgba(0,0,0,0.1)}.item-header{font-weight:600;color:#90cdf4;margin-bottom:8px}.item-details{font-size:0.9em;color:#a0aec0}.item-details strong{color:#cbd5e0}.code-block{background:#1a202c;color:#e2e8f0;padding:15px;border-radius:5px;font-family:'Courier New',monospace;font-size:12px;overflow-x:auto;margin-top:10px}.error{background:#742a2a;color:#fed7d7;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #e53e3e}.loading{text-align:center;padding:40px;color:#a0aec0}.spinner{border:3px solid rgba(255,255,255,0.1);border-top:3px solid #4299e1;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 20px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.search-box{width:100%;padding:12px 15px;border:2px solid #4a5568;border-radius:8px;margin-bottom:20px;font-size:14px;background-color:#2d3748;color:#e2e8f0}.search-box:focus{outline:none;border-color:#63b3ed;box-shadow:0 0 0 3px rgba(99,179,237,0.2)}.highlight{background-color:#f6ad55;color:#1a202c;padding:2px 4px;border-radius:3px}.settings-table{width:100%;border-collapse:collapse;margin:10px 0;font-size:0.9em}.settings-table th{background-color:#3182ce;color:white;text-align:left;padding:8px 12px}.settings-table td{padding:8px 12px;border-bottom:1px solid #4a5568;color:#e2e8f0}.settings-table tr:nth-child(even){background-color:#2d3748}.success-message{background:#2f855a;color:#f0fff4;padding:10px 15px;border-radius:8px;margin-top:10px;display:none;text-align:center;animation:fadeIn 0.5s ease-in-out}@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}@media (max-width:768px){.container{padding:20px;margin:10px}h1{font-size:2em}.stats{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}.buttons{flex-direction:column}}
    </style>
</head>
<body>
    <div class="container">
        <h1>Google Tag Manager Spy</h1>
        <h2>made with üíõ by <a href="https://joseangel.perezgarcia.es" target="_blank" rel="noopener noreferrer" class="custom-link">Jose Angel Perez</a></h2>
        <h6>Detecta el contenido de un contenedor GTM al que no tienes acceso.</h6>
        <div class="input-section">
            <textarea id="jsonInput" placeholder="Pega aqu√≠ tu JSON de Google Tag Manager..."></textarea>
            <div id="successMessage" class="success-message">Carga realizada, clica en üìä Analizar JSON</div>
            <div class="buttons">
                <button class="btn-primary" onclick="analyzeJSON()">üìä Analizar JSON</button>
                <button class="btn-tertiary" onclick="document.getElementById('fileInput').click()">üì§ Subir Archivo JSON</button>
                <input type="file" id="fileInput" class="file-input" accept=".json" onchange="handleFileUpload()">
                <button class="btn-secondary" onclick="loadSampleData()">üìã Cargar Datos de Ejemplo</button>
                <button class="btn-secondary" onclick="clearData()">üóëÔ∏è Limpiar</button>
                <button class="btn-secondary" onclick="exportResults()">üíæ Exportar Resultados en JSON</button>
            </div>
        </div>

        <div id="loading" class="loading" style="display:none">
            <div class="spinner"></div>
            <p>Analizando datos...</p>
        </div>

        <div id="error" class="error" style="display:none"></div>

        <div id="results" style="display:none">
            <input type="text" id="searchBox" class="search-box" placeholder="üîç Buscar en los resultados..." onkeyup="filterResults()">
            <div class="stats" id="stats"></div>
            <div class="categories" id="categories"></div>
        </div>
    </div>

    <script>
        let analysisData = null;
        const PARAMETER_TRANSLATIONS = {
            'sendEcommerceData':'Env√≠o de datos ecommerce','enhancedUserId':'User ID enhaced','eventName':'Nombre de evento',
            'measurementIdOverride':'ID de medici√≥n','enableUserProperties':'User Properties Enable',
            'enableMoreSettingsOption':'More Settings Option','enableEuid':'Euid Enable','tag_id':'Tag ID',
            'firingFrequency':'Firing Frequency','configSettingsTable':'Configuraci√≥n',
            'eventSettingsTable':'Par√°metros de evento','eventSettingsVariable':'Variable de evento'
        };

        function loadSampleData(){
            document.getElementById('jsonInput').value = `[{"function":"__remm","vtp_setDefaultValue":true,"vtp_input":["macro",2],"vtp_fullMatch":true,"vtp_replaceAfterMatch":true,"vtp_defaultValue":"no_cookiebot","vtp_ignoreCase":true,"vtp_map":["list",["map","key","^(20\\\\.223\\\\.9\\\\.138|34\\\\.(107\\\\.102\\\\.47|141\\\\.10\\\\.24|159\\\\.(86\\\\.126|168\\\\.195|247\\\\.222))|35\\\\.(198\\\\.(78\\\\.207|137\\\\.6|160\\\\.49)|246\\\\.(143\\\\.2|191\\\\.14)))$","value","cookiebot"]],"vtp_eventSettingsVariable":["macro",5]},{"function":"__cid"},{"function":"__gtes","vtp_eventSettingsTable":["list",["map","parameter","mensaje_enviado","parameterValue","1"],["map","parameter","user_id","parameterValue",["macro",1]]],"vtp_configSettingsTable":["list",["map","parameter","send_page_view","parameterValue","true"],["map","parameter","debug_mode","parameterValue","true"]]},{"function":"__v","vtp_name":"macro_5","vtp_defaultValue":"valor_ejemplo"}]`;
            showSuccessMessage();
        }

        function clearData(){
            document.getElementById('jsonInput').value = '';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            analysisData = null;
        }

        function handleFileUpload(){
            const file = document.getElementById('fileInput').files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try{
                    document.getElementById('jsonInput').value = e.target.result;
                    JSON.parse(e.target.result);
                    showSuccessMessage();
                }catch(error){
                    showError('El archivo no contiene un JSON v√°lido: ' + error.message);
                }
            };
            reader.onerror = () => showError('Error al leer el archivo');
            reader.readAsText(file);
        }

        function showSuccessMessage(){
            const el = document.getElementById('successMessage');
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function analyzeJSON(){
            const input = document.getElementById('jsonInput').value.trim();
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const resultsEl = document.getElementById('results');
            if(!input) return showError('Por favor, ingresa un JSON v√°lido o sube un archivo JSON.');
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            resultsEl.style.display = 'none';
            setTimeout(() => {
                try{
                    analysisData = analyzeGTMData(JSON.parse(input));
                    displayResults(analysisData);
                    loadingEl.style.display = 'none';
                    resultsEl.style.display = 'block';
                }catch(error){
                    loadingEl.style.display = 'none';
                    showError('Error al analizar el JSON: ' + error.message);
                }
            }, 500);
        }

        function analyzeGTMData(data){
            const analysis = {totalItems:data.length,tags:[],variables:[],triggers:[],functions:{},configurations:{},events:[],domains:new Set(),measurementIds:new Set()};
            data.forEach((item,index) => {
                if(!item || typeof item !== 'object') return;
                if(item.function){
                    const func = item.function;
                    analysis.functions[func] = (analysis.functions[func] || 0) + 1;
                    if(func.startsWith('__gaa') || func.startsWith('__googtag')){
                        analysis.tags.push({index,type:'Google Analytics',function:func,details:extractDetails(item,data)});
                    }else if(func.startsWith('__cvt')){
                        analysis.tags.push({index,type:'Custom Template',function:func,details:extractDetails(item,data)});
                    }else if(func.startsWith('__v') || func.startsWith('__c') || func.startsWith('__u')){
                        analysis.variables.push({index,type:getVariableType(func),function:func,details:extractDetails(item,data)});
                    }else if(func.startsWith('__evl') || func.startsWith('__lcl') || func.startsWith('__sdl')){
                        analysis.triggers.push({index,type:getTriggerType(func),function:func,details:extractDetails(item,data)});
                    }
                }
                Object.values(item).forEach(value => {
                    if(typeof value === 'string'){
                        if(value.match(/^G-[A-Z0-9]+$/)) analysis.measurementIds.add(value);
                        else if(value.match(/^GT-[A-Z0-9]+$/)) analysis.measurementIds.add(value);
                        const urlMatch = value.match(/https?:\/\/([^\/\s]+)/);
                        if(urlMatch) analysis.domains.add(urlMatch[1]);
                    }
                });
                if(item.vtp_eventName) analysis.events.push({name:item.vtp_eventName,index,details:extractDetails(item,data)});
                if(item.vtp_configSettingsTable || item.vtp_eventSettingsTable) analysis.configurations[index] = {type:'Configuration',function:item.function,details:extractDetails(item,data)};
            });
            return analysis;
        }

        function extractDetails(item,data){
            const details = {};
            Object.keys(item).forEach(key => {
                if(key.startsWith('vtp_') || key === 'function' || key === 'tag_id'){
                    const cleanKey = key.startsWith('vtp_') ? key.substring(4) : key;
                    const displayKey = PARAMETER_TRANSLATIONS[cleanKey] || cleanKey;
                    if(Array.isArray(item[key]) && item[key][0] === 'macro'){
                        const macroIndex = item[key][1];
                        details[displayKey] = {reference:item[key],value:getMacroValue(macroIndex,data)};
                    }else details[displayKey] = item[key];
                }
            });
            return details;
        }

        function getMacroValue(macroIndex,data){
            if(!data || !data[macroIndex]) return 'No disponible';
            const macro = data[macroIndex];
            if(macro.vtp_defaultValue !== undefined) return macro.vtp_defaultValue;
            if(macro.vtp_value !== undefined) return macro.vtp_value;
            if(macro.vtp_name !== undefined) return macro.vtp_name;
            return 'Valor no encontrado';
        }

        function getVariableType(func){
            const types = {'__v':'Data Layer Variable','__c':'Constant','__u':'URL Variable','__r':'Random Number','__e':'Event','__f':'Referrer','__aev':'Auto-Event Variable','__cid':'Client ID','__hid':'Hit ID','__ctv':'Container Version','__dbg':'Debug Mode'};
            return types[func] || 'Unknown Variable';
        }

        function getTriggerType(func){
            const types = {'__evl':'Element Visibility','__lcl':'Link Click','__sdl':'Scroll Depth','__cl':'Click','__hl':'History Change','__ytl':'YouTube Video'};
            return types[func] || 'Unknown Trigger';
        }

        function displayResults(analysis){
            displayStats(analysis);
            displayCategories(analysis);
        }

        function displayStats(analysis){
            const stats = [
                {label:'Elementos',value:analysis.totalItems},
                {label:'Etiquetas',value:analysis.tags.length},
                {label:'Variables',value:analysis.variables.length},
                {label:'Activadores',value:analysis.triggers.length},
                {label:'Measurement IDs',value:analysis.measurementIds.size},
                {label:'Dominios',value:analysis.domains.size}
            ];
            document.getElementById('stats').innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <span class="stat-number">${stat.value}</span>
                    <span class="stat-label">${stat.label}</span>
                </div>
            `).join('');
        }

        function displayCategories(analysis){
            const categories = [
                {title:`üè∑Ô∏è Etiquetas (${analysis.tags.length})`,items:analysis.tags,id:'tags'},
                {title:`üìä Variables (${analysis.variables.length})`,items:analysis.variables,id:'variables'},
                {title:`‚ö° Activadores (${analysis.triggers.length})`,items:analysis.triggers,id:'triggers'},
                {title:`üéØ Eventos (${analysis.events.length})`,items:analysis.events,id:'events'},
                {title:`üîß Funciones`,items:Object.entries(analysis.functions).map(([func,count]) => ({function:func,count,type:'Function Usage'})),id:'functions'},
                {title:`üåê Dominios (${analysis.domains.size})`,items:Array.from(analysis.domains).map(domain => ({domain,type:'Domain'})),id:'domains'},
                {title:`üÜî Measurement IDs (${analysis.measurementIds.size})`,items:Array.from(analysis.measurementIds).map(id => ({measurementId:id,type:'Measurement ID'})),id:'measurementIds'}
            ];
            document.getElementById('categories').innerHTML = categories.map(category => `
                <div class="category" id="category-${category.id}">
                    <div class="category-header" onclick="toggleCategory('${category.id}')">
                        <span>${category.title}</span>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="category-content">${renderItems(category.items,category.id)}</div>
                </div>
            `).join('');
        }

        function renderItems(items,categoryId){
            if(!items || items.length === 0) return '<p style="color:#a0aec0;font-style:italic;">No hay items en esta categor√≠a</p>';
            return items.map(item => `<div class="item">${
                categoryId === 'functions' ? `
                    <div class="item-header">${item.function}</div>
                    <div class="item-details"><strong>N√∫mero de elementos:</strong> ${item.count}</div>` :
                categoryId === 'domains' ? `
                    <div class="item-header">${item.domain}</div>
                    <div class="item-details"><strong>Type:</strong> ${item.type}</div>` :
                categoryId === 'measurementIds' ? `
                    <div class="item-header">${item.measurementId}</div>
                    <div class="item-details"><strong>Type:</strong> ${item.type}</div>` :
                categoryId === 'events' ? `
                    <div class="item-header">${item.name || 'Unnamed Event'}</div>
                    <div class="item-details"><strong>Index:</strong> ${item.index}<br>${item.details ? renderDetails(item.details) : ''}</div>` : `
                    <div class="item-header">${item.type} - ${item.function}</div>
                    <div class="item-details"><strong>Index:</strong> ${item.index}<br>${item.details ? renderDetails(item.details) : ''}</div>`
            }</div>`).join('');
        }

        function renderDetails(details){
            return Object.entries(details).filter(([_,value]) => value !== undefined && value !== null).map(([key,value]) => {
                if(key === 'Par√°metros de evento' || key === 'Configuraci√≥n') return renderSettingsTable(value,key);
                if(typeof value === 'object' && value.reference && Array.isArray(value.reference)) return `
                    <strong>${key}:</strong> <div class="code-block">${JSON.stringify(value.reference,null,2)}</div>
                    <div><strong>Valor:</strong> ${value.value}</div>`;
                const displayValue = typeof value === 'object' ? `<div class="code-block">${JSON.stringify(value,null,2)}</div>` : String(value);
                return `<strong>${key}:</strong> ${displayValue}`;
            }).join('<br>');
        }

        function renderSettingsTable(settings,title){
            if(!settings || !Array.isArray(settings)) return '';
            const params = [];
            for(let i=1;i<settings.length;i++){
                const item = settings[i];
                if(Array.isArray(item) && item[0] === 'map'){
                    let paramName = '', paramValue = '';
                    for(let j=1;j<item.length;j+=2){
                        if(item[j] === 'parameter') paramName = item[j+1];
                        else if(item[j] === 'parameterValue') paramValue = item[j+1];
                    }
                    if(paramName) params.push({name:paramName,value:paramValue});
                }
            }
            if(params.length === 0) return `<strong>${title}:</strong> No hay par√°metros configurados`;
            return `<div><strong>${title}:</strong><table class="settings-table"><thead><tr><th>Par√°metro</th><th>Valor</th></tr></thead><tbody>${
                params.map(param => `<tr><td>${param.name}</td><td>${
                    typeof param.value === 'object' ? JSON.stringify(param.value) : param.value
                }</td></tr>`).join('')
            }</tbody></table></div>`;
        }

        function toggleCategory(categoryId){
            document.getElementById(`category-${categoryId}`).classList.toggle('expanded');
        }

        function filterResults(){
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            if(!searchTerm){
                document.querySelectorAll('.category').forEach(category => {
                    category.style.display = 'block';
                    category.querySelectorAll('.item').forEach(item => {
                        item.style.display = 'block';
                        item.innerHTML = item.innerHTML.replace(/<span class="highlight">(.*?)<\/span>/g,'$1');
                    });
                });
                return;
            }
            document.querySelectorAll('.category').forEach(category => {
                let hasVisibleItems = false;
                category.querySelectorAll('.item').forEach(item => {
                    const content = item.textContent.toLowerCase();
                    const htmlContent = item.innerHTML;
                    if(content.includes(searchTerm)){
                        item.style.display = 'block';
                        hasVisibleItems = true;
                        item.innerHTML = htmlContent.replace(new RegExp(`(${searchTerm})`,'gi'),'<span class="highlight">$1</span>');
                    }else{
                        item.style.display = 'none';
                        item.innerHTML = htmlContent.replace(/<span class="highlight">(.*?)<\/span>/g,'$1');
                    }
                });
                category.style.display = hasVisibleItems ? 'block' : 'none';
                if(hasVisibleItems && !category.classList.contains('expanded')) category.classList.add('expanded');
            });
        }

        function exportResults(){
            if(!analysisData) return showError('No hay datos para exportar. Analiza un JSON primero.');
            const exportData = {
                timestamp:new Date().toISOString(),
                summary:{
                    totalItems:analysisData.totalItems,
                    tags:analysisData.tags.length,
                    variables:analysisData.variables.length,
                    triggers:analysisData.triggers.length,
                    events:analysisData.events.length,
                    domains:Array.from(analysisData.domains),
                    measurementIds:Array.from(analysisData.measurementIds)
                },
                details:analysisData
            };
            const blob = new Blob([JSON.stringify(exportData,null,2)],{type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gtm-spy-analysis-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showError(message){
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        document.getElementById('jsonInput').addEventListener('input',function(){
            if(this.value.trim().length > 0) showSuccessMessage();
        });

        window.addEventListener('load',loadSampleData);
    </script>
</body>
</html>